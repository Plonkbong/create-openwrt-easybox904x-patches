From d1359d9a7cd3a67727300a6b6ac1013096114ec1 Mon Sep 17 00:00:00 2001
From: Quallenauge <Hamsi2k@freenet.de>
Date: Wed, 21 Feb 2018 23:43:00 -0100
Subject: [PATCH 01/16] VGV952CJW33-E-IR: Add dts for VGV952CJW33-E-IR.

---
 .../arch/mips/boot/dts/VGV952CJW33-E-IR.dts        | 391 +++++++++++++++++++++
 1 file changed, 391 insertions(+)
 create mode 100644 target/linux/lantiq/files-4.14/arch/mips/boot/dts/VGV952CJW33-E-IR.dts

diff --git a/target/linux/lantiq/files-4.14/arch/mips/boot/dts/VGV952CJW33-E-IR.dts b/target/linux/lantiq/files-4.14/arch/mips/boot/dts/VGV952CJW33-E-IR.dts
new file mode 100644
index 0000000..42d55c1
--- /dev/null
+++ b/target/linux/lantiq/files-4.14/arch/mips/boot/dts/VGV952CJW33-E-IR.dts
@@ -0,0 +1,391 @@
+/dts-v1/;
+
+#include "vr9.dtsi"
+
+#include <dt-bindings/input/input.h>
+#include <dt-bindings/mips/lantiq_rcu_gphy.h>
+
+/ {
+	model = "EasyBox 904 xDSL";
+	compatible = "lantiq,vgv952cjw33-e-ir", "lantiq,xway", "lantiq,vr9";
+
+	chosen {
+		// Bootargs when no vpe is used
+		// bootargs = "console=ttyLTQ0,115200 ubi.mtd=12,2048 panic=1 DTS-TEST-SEQNO=77 root=/dev/ubiblock0_0 rootdelay=7";
+
+		// Bootargs when vpe is used
+			// Bootargs to boot from mtd12 ubifs
+			// bootargs = "console=ttyLTQ0,115200 ubi.mtd=12,2048 panic=1 DTS-TEST-SEQNO=77  root=/dev/ubiblock0_0 rootdelay=7 mem=116M phym=128M vpe1_load_addr=0x87e00000 vpe1_mem=2M maxvpes=1 maxtcs=1 nosmp";
+			bootargs = "console=ttyLTQ0,115200 ubi.mtd=12,2048 panic=1 DTS-TEST-SEQNO=77 root=/dev/ubiblock0_0 rootdelay=7 mem=116M phym=128M vpe1_load_addr=0x87e00000 vpe1_mem=2M maxvpes=1 maxtcs=1 nosmp";
+
+			// Bootargs to boot from sda1
+			// bootargs = "console=ttyLTQ0,115200 panic=1 DTS-TEST-SEQNO=77 root=/dev/sda1 rootdelay=7 rootfstype=f2fs mem=116M phym=128M vpe1_load_addr=0x87e00000 vpe1_mem=2M maxvpes=1 maxtcs=1 nosmp";
+	};
+
+	memory@0 {
+		reg = <0x0 0x8000000>;
+	};
+
+	easybox904-display{
+		compatible = "ilitek,ili9341_eb904";
+		#address-cells = <1>;
+		#size-cells = <0>;
+		status = "okay";
+		rotate = <270>;
+		fps = <30>;
+		bgr;
+		buswidth = <8>;
+		reset-gpios = <&gpio 6 GPIO_ACTIVE_HIGH>;
+		led-gpios = <&gpio 28 GPIO_ACTIVE_LOW>;
+		debug = <1>;
+	};
+
+	gpio-keys-polled {
+		compatible = "gpio-keys-polled";
+		#address-cells = <1>;
+		#size-cells = <0>;
+		poll-interval = <100>;
+		rfkill {
+			label = "wps";
+			gpios = <&gpio 3 GPIO_ACTIVE_LOW>;
+			linux,code = <KEY_WPS_BUTTON>;
+		};
+		reset {
+			label = "reset";
+			gpios = <&gpio 40 GPIO_ACTIVE_LOW>;
+			linux,code = <KEY_RESTART>;
+		};
+	};
+
+	usb_vbus: regulator-usb-vbus {
+		compatible = "regulator-fixed";
+
+		regulator-name = "USB_VBUS";
+
+		regulator-min-microvolt = <5000000>;
+		regulator-max-microvolt = <5000000>;
+
+		gpio = <&gpio 33 GPIO_ACTIVE_HIGH>;
+		enable-active-high;
+	};
+
+	gpio-leds {
+			compatible = "gpio-leds";
+			power_green: power {
+			label = "VGV952CJW33:red:power";
+			gpios = <&gpio 31 GPIO_ACTIVE_LOW>;
+			default-state = "keep";
+		};
+	};
+
+	i2c {
+		compatible = "i2c-gpio";
+		#address-cells = <1>;
+		#size-cells = <0>;
+		gpios = <&gpio 19 GPIO_ACTIVE_HIGH /* sda */
+			&gpio 14 GPIO_ACTIVE_HIGH /* scl */
+		>;
+		//i2c-gpio,sda-open-drain;
+		//i2c-gpio,scl-open-drain;
+		i2c-gpio,delay-us = <5>;
+		/* Add touch panel Support */
+		tp: eb904tp@0x14 {
+			compatible = "lantiq,eb904_keypad";
+			reg = <0x14>;
+			interrupt-parent = <&icu0>;
+			interrupts = <135>;
+			eb904,interrupt-gpio = <&gpio  0 GPIO_ACTIVE_HIGH /* EXIN */>;
+			eb904,ctrl-clk-gpios = <&gpio 29 GPIO_ACTIVE_HIGH /* clk */>;
+			eb904,ctrl-dat-gpios = <&gpio 30 GPIO_ACTIVE_HIGH /* dat */>;
+			eb904,ctrl-out-gpios = <&gpio 39 GPIO_ACTIVE_HIGH /* out */>;
+			eb904,alphas = /bits/ 8
+				 <0x07 /* left */
+				  0x0a /* down */
+				  0x0a /* right */
+				  0x0a /* ok */
+				  0x07 /* up */
+			>;
+			keypad,num-rows = <3>;
+			keypad,num-columns = <3>;
+			linux,keymap = <
+				    MATRIX_KEY(0x0, 0x1, KEY_UP)         /* ROW0, COL1 */
+				    MATRIX_KEY(0x1, 0x0, KEY_LEFT)       /* ROW1, COL0 */
+				    MATRIX_KEY(0x1, 0x1, KEY_ENTER)      /* ROW1, COL1 */
+				    MATRIX_KEY(0x1, 0x2, KEY_RIGHT)      /* ROW1, COL2 */
+				    MATRIX_KEY(0x2, 0x1, KEY_DOWN)       /* ROW2, COL1 */
+				    >;
+		};
+	};
+
+	mdio: mdio {
+			compatible = "lantiq,xrx200-mdio";
+			#address-cells = <1>;
+			#size-cells = <0>;
+			phy0: ethernet-phy@0 {
+				reg = <0x0>;
+				compatible = "lantiq,phy11g", "ethernet-phy-ieee802.3-c22";
+			};
+			phy1: ethernet-phy@1 {
+				reg = <0x1>;
+				compatible = "lantiq,phy11g", "ethernet-phy-ieee802.3-c22";
+			};
+			/*
+			phy5: ethernet-phy@5 {
+				reg = <0x5>;
+			};
+			*/
+			phy11: ethernet-phy@11 {
+				reg = <0x11>;
+				compatible = "lantiq,phy11g", "ethernet-phy-ieee802.3-c22";
+			};
+			phy12: ethernet-phy@12 {
+				reg = <0x12>;
+				compatible = "lantiq,phy11g", "ethernet-phy-ieee802.3-c22";
+			};
+			phy13: ethernet-phy@13 {
+				reg = <0x13>;
+				compatible = "lantiq,phy11g", "ethernet-phy-ieee802.3-c22";
+			};				
+			phy14: ethernet-phy@14 {
+				reg = <0x14>;
+				compatible = "lantiq,phy11g", "ethernet-phy-ieee802.3-c22";
+			};
+		};
+
+	rtl8367b {
+		compatible = "realtek,rtl8367b";
+		//gpio-sda = <&gpio0 1 0>;
+		//gpio-sck = <&gpio0 2 0>;
+		//cpu_port = <7>;
+		realtek,extif0 = <1 0 1 1 1 1 1 1 2>; // default found on other profiles
+		//realtek,extif1   = <1 0 1 1 0 0 1 1 2>; // based on vendor uboot-config
+		mdio = <&mdio>;
+	};
+};
+
+&vmmc {
+	status = "okay";
+	gpios = <&gpio 37 GPIO_ACTIVE_HIGH>; //reset_slic!
+};
+
+&localbus {
+    ranges = <0 0 0x4000000 0x3ffffff>; // Default in vr9.dtsi is crashing the machine.
+    nand@0 {
+            compatible = "lantiq,nand-xway";
+            bank-width = <2>;
+            reg = <0 0x0 0x2000000>;
+            #address-cells = <1>;
+            #size-cells = <1>;
+            lantiq,cs = <1>;			// Seems to be needed (EASY80920NAND.dts)
+
+            nand-on-flash-bbt;
+            nand-ecc-strength = <3>;
+            nand-ecc-step-size = <256>;
+
+            partitions {
+                compatible = "fixed-partitions";
+                #address-cells = <1>;
+                #size-cells = <1>;
+                partition@0 {
+                    label = "uboot";
+                    reg = <0x0 0x40000>;
+                };
+
+                partition@40000 {
+                    label = "rootfs";		// Called "rootfs" in u-boot env. Contains orig. squashfs rootfs
+                    reg = <0x40000 0x3C00000>;
+                };
+
+                partition@3C40000 {
+                    label = "kernel";		// Called "kernel" in u-boot env. Contains orig. kernel
+                    reg = <0x3C40000 0x500000>;
+                };
+
+                partition@4140000 {
+                    label = "tmp1";
+                    reg = <0x4140000 0x100000>;
+                };
+
+                partition@4240000 {
+                    label = "tmp2";
+                    reg = <0x4240000 0x200000>;
+                };
+
+                partition@4440000 {
+                    label = "sysconfig";
+                    reg = <0x4440000 0x100000>;
+                };
+
+                partition@4540000 {
+                    label = "ubootconfig";
+                    reg = <0x4540000 0x100000>;
+                };
+
+                partition@4640000 {
+                    label = "fwdiag";
+                    reg = <0x4640000 0xC0000>;
+                };
+
+                partition@4700000 {
+                    label = "lcdimage";
+                    reg = <0x4700000 0x300000>;
+                };
+
+                partition@4A00000 {
+                    label = "mfgconfig";
+                    reg = <0x4A00000 0x100000>;
+                };
+
+                partition@4B00000 {
+                    label = "sipdata";
+                    reg = <0x4B00000 0x100000>;
+                };
+
+                partition@4C00000 {
+                    label = "voice";
+                    reg = <0x4C00000 0x4000000>;
+                };
+
+                partition@8C00000 {			// Used for our real open OpenWrt system for ubi-squashfs (rootfs) and ubifs (rootfs_data)
+                    label = "ubi";			// Rename to "firmware" for special squashfs-rootfs/jffs2-rootfs_data treatment by OpenWrt
+                    reg = <0x8C00000 0x13200000>;
+                };
+
+                partition@1BE00000 {
+                    label = "rootfs2";
+                    reg = <0x1BE00000 0x3c00000>;
+                };
+
+                partition@1FA00000 {
+                    label = "kernel2";
+                    reg = <0x1FA00000 0x500000>;
+                };
+
+                partition@1FF00000 {
+                    label = "mystery";		// Missing in original u-boot environment, seems to be empty (erased)
+                    reg = <0x1FF00000 0x100000>;
+                };
+            };
+    };
+};
+
+/*
+*  Following is the very experimental part which is broken and requires much more elaboration
+*/
+
+&stp {
+	compatible = "lantiq,gpio-stp-xway";
+	reg = <0xE100BB0 0x40>;
+	#gpio-cells = <2>;
+	gpio-controller;
+
+	lantiq,shadow = <0xffff>;
+	lantiq,groups = <0x7>;
+	lantiq,dsl = <0x3>;
+	lantiq,phy1 = <0x7>;
+	lantiq,phy2 = <0x7>;
+};
+
+
+// From FRITZ3370.dts
+&gpio {
+	pinctrl-names = "default";
+	pinctrl-0 = <&state_default>;
+
+	state_default: pinmux {
+		mdio {
+			lantiq,groups = "mdio";
+			lantiq,function = "mdio";
+		};
+
+		phy-rst {	// I have no idea wether this makes sense
+			lantiq,pins = "io37", "io44";			// FRITZ3370.dts
+		  //	lantiq,pins = "io42";				// TDW8970.dts
+			lantiq,pull = <0>;
+			lantiq,open-drain = <0>;
+			lantiq,output = <1>;
+						};
+
+		pcie-rst {
+			lantiq,pins = "io38";				// FRITZ3370.dts, TDW8970.dts, EASY80920.dtsi, P2812HNUFX.dtsi
+		   //  	lantiq,pins = "io21";				// ARV7519RW22.dts
+			lantiq,pull = <0>;
+			lantiq,output = <1>;
+		};
+
+		exin1 {
+			lantiq,groups = "exin1";
+			lantiq,function = "exin";
+		};
+
+		conf_tp {
+			lantiq,pins = "io1"; /* exin1 */
+			lantiq,open-drain;
+			lantiq,pull = <0>;
+		};
+	};
+};
+
+&usb_phy0 {
+    status = "okay";
+};
+
+&usb0 {
+    status = "okay";
+    vbus-supply = <&usb_vbus>;
+};
+
+&eth0 {
+	lan: interface@0 {
+		compatible = "lantiq,xrx200-pdi";
+		#address-cells = <1>;
+		#size-cells = <0>;
+		reg = <0>;                                
+		mac-address = [ 00 11 22 33 44 55 ];
+		lantiq,switch;
+		ethernet@2 {
+			compatible = "lantiq,xrx200-pdi-port";
+			reg = <2>;
+			phy-mode = "gmii";
+			// phy-handle = <&phy11>;
+			fixed-link {
+				speed = <1000>;
+				full-duplex;
+			};
+		};
+		/* wan port */
+		ethernet@4 {
+			compatible = "lantiq,xrx200-pdi-port";
+			reg = <4>;
+			phy-mode = "gmii";
+			phy-handle = <&phy13>;
+		};
+		/* rt3883 soc */
+		/*
+		ethernet@5 {
+			compatible = "lantiq,xrx200-pdi-port";
+			reg = <5>;
+			phy-mode = "rgmii";
+			phy-handle = <&phy5>;
+		};
+		*/
+	};
+};
+
+&pci0 {
+	status = "disabled";
+	//gpio-reset = <&gpio 21 GPIO_ACTIVE_HIGH>;
+};
+
+&pcie0 {
+	pcie@0 {
+		reg = <0 0 0 0 0>;
+		#interrupt-cells = <1>;
+		#size-cells = <2>;
+		#address-cells = <3>;
+		device_type = "pci";
+	};
+};
+
+
+
-- 
2.7.4


From 7ad2c99b184fe767a45e78c08b587d2ae7530cf7 Mon Sep 17 00:00:00 2001
From: Quallenauge <Hamsi2k@freenet.de>
Date: Wed, 27 Jun 2018 20:40:37 +0200
Subject: [PATCH 02/16] VGV952CJW33-E-IR: Wait until mdio bus appears.

---
 .../arch/mips/boot/dts/VGV952CJW33-E-IR.dts        |  6 +--
 .../4055-NET-rtl8367b-wait-for-mdio-bus.patch      | 54 ++++++++++++++++++++++
 2 files changed, 57 insertions(+), 3 deletions(-)
 create mode 100644 target/linux/lantiq/patches-4.14/4055-NET-rtl8367b-wait-for-mdio-bus.patch

diff --git a/target/linux/lantiq/files-4.14/arch/mips/boot/dts/VGV952CJW33-E-IR.dts b/target/linux/lantiq/files-4.14/arch/mips/boot/dts/VGV952CJW33-E-IR.dts
index 42d55c1..e0bd4c9 100644
--- a/target/linux/lantiq/files-4.14/arch/mips/boot/dts/VGV952CJW33-E-IR.dts
+++ b/target/linux/lantiq/files-4.14/arch/mips/boot/dts/VGV952CJW33-E-IR.dts
@@ -157,9 +157,9 @@
 		//gpio-sda = <&gpio0 1 0>;
 		//gpio-sck = <&gpio0 2 0>;
 		//cpu_port = <7>;
-		realtek,extif0 = <1 0 1 1 1 1 1 1 2>; // default found on other profiles
-		//realtek,extif1   = <1 0 1 1 0 0 1 1 2>; // based on vendor uboot-config
-		mdio = <&mdio>;
+		//realtek,extif0 = <1 0 1 1 1 1 1 1 2>; // default found on other profiles
+		realtek,extif1   = <1 0 1 1 0 0 1 1 2>; // based on vendor uboot-config
+		mii-bus = <&mdio>;
 	};
 };
 
diff --git a/target/linux/lantiq/patches-4.14/4055-NET-rtl8367b-wait-for-mdio-bus.patch b/target/linux/lantiq/patches-4.14/4055-NET-rtl8367b-wait-for-mdio-bus.patch
new file mode 100644
index 0000000..7325c67
--- /dev/null
+++ b/target/linux/lantiq/patches-4.14/4055-NET-rtl8367b-wait-for-mdio-bus.patch
@@ -0,0 +1,54 @@
+From 5a5d5130a628583c4137110a3189fe2f3c5c265a Mon Sep 17 00:00:00 2001
+From: Quallenauge <Hamsi2k@freenet.de>
+Date: Wed, 27 Jun 2018 20:35:47 +0200
+Subject: [PATCH] rtl8367b: Defer init until mdio bus appears.
+
+---
+ drivers/net/phy/rtl8367b.c | 21 +++++++++++++++++++++
+ 1 file changed, 21 insertions(+)
+
+diff --git a/drivers/net/phy/rtl8367b.c b/drivers/net/phy/rtl8367b.c
+index e6ea6509..770bf0bc 100644
+--- a/drivers/net/phy/rtl8367b.c
++++ b/drivers/net/phy/rtl8367b.c
+@@ -17,9 +17,11 @@
+ #include <linux/delay.h>
+ #include <linux/skbuff.h>
+ #include <linux/rtl8367.h>
++#include <linux/of_mdio.h>
+ 
+ #include "rtl8366_smi.h"
+ 
++
+ #define RTL8367B_RESET_DELAY	1000	/* msecs*/
+ 
+ #define RTL8367B_PHY_ADDR_MAX	8
+@@ -1526,6 +1528,25 @@ static int  rtl8367b_probe(struct platform_device *pdev)
+ 	struct rtl8366_smi *smi;
+ 	int err;
+ 
++#ifdef CONFIG_OF
++    struct device_node *np = pdev->dev.of_node;
++	struct device_node *mdio_node;
++	struct mii_bus * ext_mbus;
++	mdio_node = of_parse_phandle(np, "mii-bus", 0);
++	if (!mdio_node) {
++		dev_err(&pdev->dev, "cannot find mdio node phandle");
++		goto try_gpio;
++	}
++
++	ext_mbus = of_mdio_find_bus(mdio_node);
++	if (!ext_mbus) {
++		dev_err(&pdev->dev,
++			"cannot find mdio bus from bus handle, try again later");
++		return -EPROBE_DEFER;
++	}
++
++try_gpio:
++#endif
+ 	smi = rtl8366_smi_probe(pdev);
+ 	if (!smi)
+ 		return -ENODEV;
+-- 
+2.18.0
+
-- 
2.7.4


From 2083ce73540aca3fa1cec99c3174aa2e0b4864a8 Mon Sep 17 00:00:00 2001
From: Quallenauge <Hamsi2k@freenet.de>
Date: Wed, 21 Feb 2018 23:43:00 -0100
Subject: [PATCH 03/16] VGV952CJW33-E-IR: Add image generation configuration.
 Add functionality to generate a full image which can be used by the recovery
 flash algorithm.

---
 target/linux/lantiq/image/Makefile |   1 +
 target/linux/lantiq/image/eb904.mk | 105 +++++++++++++++++++++++++++++++++++++
 2 files changed, 106 insertions(+)
 create mode 100644 target/linux/lantiq/image/eb904.mk

diff --git a/target/linux/lantiq/image/Makefile b/target/linux/lantiq/image/Makefile
index fca3fce..2891256 100644
--- a/target/linux/lantiq/image/Makefile
+++ b/target/linux/lantiq/image/Makefile
@@ -12,6 +12,7 @@ KERNEL_LOADADDR = 0x80002000
 KERNEL_ENTRY = 0x80002000
 
 include $(TOPDIR)/rules.mk
+include eb904.mk
 include $(INCLUDE_DIR)/image.mk
 
 ifeq ($(SUBTARGET),xway)
diff --git a/target/linux/lantiq/image/eb904.mk b/target/linux/lantiq/image/eb904.mk
new file mode 100644
index 0000000..082e3cb
--- /dev/null
+++ b/target/linux/lantiq/image/eb904.mk
@@ -0,0 +1,105 @@
+#
+# Copyright (C) 2010-2016 OpenWrt.org
+#
+# This is free software, licensed under the GNU General Public License v2.
+# See /LICENSE for more information.
+#
+NAND_BLOCKSIZE ?= 2048-128k
+
+define Image/Build
+    $(call Image/Build/$(1),$(1))
+endef
+
+define Build/uImage_eb904
+	mkimage -A $(LINUX_KARCH) \
+		-O linux -T kernel \
+		-C $(1) -a $(KERNEL_LOADADDR) -e $(if $(KERNEL_ENTRY),$(KERNEL_ENTRY),$(KERNEL_LOADADDR)) \
+		-n '$(if $(UIMAGE_NAME),$(UIMAGE_NAME),$(call toupper,$(LINUX_KARCH)) LEDE Linux-$(LINUX_VERSION))' \
+		-d $@ $@.new.padded
+	@mv $@.new.padded $@
+endef
+
+define Build/fullimage_eb904_root
+	mkimage -A mips -O linux -C lzma -T filesystem -a 0x00 \
+		-e 0x00 -n 'LEDE RootFS' \
+		-d $@ $@.mkimage
+	cat $@.mkimage > $@
+endef
+
+define Build/fullimage_eb904_function
+	IMAGE_LIST="$(1) \
+	$(2)"; \
+	ONEIMAGE="$(1).oneimage"; \
+	PLATFORM=`echo $(SUBTARGET)|cut -d_ -f2-|awk '{ print toupper($$1) }'`; \
+	rm -f $$ONEIMAGE; \
+	echo "IMAGE_LIST: $$IMAGE_LIST"; \
+	for i in $$IMAGE_LIST; do \
+		if [ -e $$i  ] ; then \
+			echo "Prepare $$i"; \
+			len=`wc -c $$i | awk '{ printf $$1 }'`; \
+			pad=`expr 16 - $$len % 16`; \
+			pad=`expr $$pad % 16`; \
+			if [ -e $$ONEIMAGE.tmp ] ; then \
+				cat $$i >> $$ONEIMAGE.tmp; \
+			else \
+				cat $$i > $$ONEIMAGE.tmp; \
+			fi; \
+			while [ $$pad -ne 0 ]; do \
+				echo -n "0" >> $$ONEIMAGE.tmp; \
+				pad=`expr $$pad - 1`; \
+			done; \
+		else \
+			echo "$$i not found!"; \
+			rm -f $$ONEIMAGE.tmp; \
+			exit 1; \
+		fi; \
+	done; \
+	mkimage -A MIPS -O Linux -C none -T multi -e 0x00 -a 0x00 -n \
+		"$$PLATFORM Fullimage" -d $$ONEIMAGE.tmp $$ONEIMAGE; \
+	rm -f $$ONEIMAGE.tmp; \
+	chmod 644 $$ONEIMAGE;
+
+	cat $(1).oneimage > $(1);
+endef
+
+define Build/fullimage_eb904_recovery
+	$(call Build/fullimage_eb904_function,$@,$(KDIR)/tmp/$(KERNEL_INITRAMFS_IMAGE))
+endef
+define Build/fullimage_eb904
+	$(call Build/fullimage_eb904_function,$@,$(IMAGE_KERNEL))
+endef
+
+ifeq ($(SUBTARGET),xrx200)
+
+# VR9
+define Device/lantiq_vgv952cjw33-e-ir
+  BLOCKSIZE := 126976
+  PAGESIZE := 2048
+  SUBPAGESIZE := 2048
+  FILESYSTEMS += ubifs
+  UBIFS_OPTS := -m 2048 -e 126976 -c 2047
+
+  IMAGE_SIZE := 32768k
+  MAGIC := 0x27051956
+  DEVICE_TITLE := VGV952CJW33-E-IR - Lantiq Easybox 904
+  DEVICE_DTS := VGV952CJW33-E-IR
+  DEVICE_PACKAGES := kmod-usb-dwc2 kmod-ltq-tapi kmod-ltq-vmmc
+  KERNEL := kernel-bin | append-dtb | lzma | pad-offset 128k 64 | uImage lzma
+#  IMAGES := fullimage-recovery.bin
+  IMAGES := sysupgrade.bin rootfs-ubinized.bin
+  IMAGE/fullimage-ubinized.bin := append-ubi | fullimage_eb904_root | fullimage_eb904 | check-size $$$$(IMAGE_SIZE)
+  IMAGE/fullimage-recovery.bin := append-uImage-fakeroot-hdr | fullimage_eb904_recovery | check-size $$$$(IMAGE_SIZE)
+  IMAGE/sysupgrade.bin := sysupgrade-tar | append-metadata
+  IMAGE/rootfs-ubinized.bin := append-rootfs
+  SUPPORTED_DEVICES += VGV952CJW33-E-IR
+
+#  experimental settings
+#  FEATURES += jffs2_nand
+#  FILESYSTEMS += jffs2-nand-2048-128k
+#  IMAGES := fullimage-ubinized.bin fullimage-jffs2.bin
+#  IMAGE/fullimage-jffs2.bin    := append-rootfs | pad-offset 4096 0 | fullimage_eb904 | check-size $$$$(IMAGE_SIZE)
+endef
+TARGET_DEVICES += lantiq_vgv952cjw33-e-ir
+
+endif
+
-- 
2.7.4


From c13284ae9ea276de8fea47d33cc82f535a8b3a1f Mon Sep 17 00:00:00 2001
From: Quallenauge <Hamsi2k@freenet.de>
Date: Wed, 21 Feb 2018 23:43:00 -0100
Subject: [PATCH 04/16] VGV952CJW33-E-IR: Sysupgrade: Deactivate subpages on
 nand.

Currently, subpages aren't working on the easybox 904 xdsl nand flash.
Allthough, The nand driver seems to report it is supported, which isn't.
If not specified the deactivation of subpages, ubi leds to errors
when formatting and attaching, detaching and reattaching the ubi partition.

This patch introduced a new property in nand.sh to control this behavior.
http://www.linux-mtd.infradead.org/faq/ubi.html#L_force_no_subpage
---
 package/base-files/files/lib/upgrade/nand.sh       | 23 +++++++++++++++++++---
 .../lantiq/base-files/lib/upgrade/platform.sh      | 16 ++++++++++++++-
 2 files changed, 35 insertions(+), 4 deletions(-)

diff --git a/package/base-files/files/lib/upgrade/nand.sh b/package/base-files/files/lib/upgrade/nand.sh
index 99916a4..0e726f7 100644
--- a/package/base-files/files/lib/upgrade/nand.sh
+++ b/package/base-files/files/lib/upgrade/nand.sh
@@ -10,8 +10,13 @@ CI_KERNPART="${CI_KERNPART:-kernel}"
 # 'ubi' partition on NAND contains UBI
 CI_UBIPART="${CI_UBIPART:-ubi}"
 
+# <<<<<<<
 # 'rootfs' partition on NAND contains the rootfs
 CI_ROOTPART="${CI_ROOTPART:-rootfs}"
+# =======
+# VID header offset is used e.g. to ignore sub pages by setting them to 2048
+CU_UBI_VID_HEADER_OFFSET=""
+# >>>>>>>
 
 ubi_mknod() {
 	local dir="$1"
@@ -129,14 +134,26 @@ nand_upgrade_prepare_ubi() {
 
 	local ubidev="$( nand_find_ubi "$CI_UBIPART" )"
 	if [ ! "$ubidev" ]; then
-		ubiattach -m "$mtdnum"
+		if [ ! -z $CU_UBI_VID_HEADER_OFFSET ]; then
+		    echo "Forcing ubiattach with possible non standard VID header offset of <$CU_UBI_VID_HEADER_OFFSET>"
+		    ubiattach -m "$mtdnum" -O $CU_UBI_VID_HEADER_OFFSET
+		else
+		    ubiattach -m "$mtdnum"
+		fi
 		sync
 		ubidev="$( nand_find_ubi "$CI_UBIPART" )"
 	fi
 
 	if [ ! "$ubidev" ]; then
-		ubiformat /dev/mtd$mtdnum -y
-		ubiattach -m "$mtdnum"
+		if [ ! -z $CU_UBI_VID_HEADER_OFFSET ]; then
+		    echo "Forcing ubiformat with possible non standard VID header offset of <$CU_UBI_VID_HEADER_OFFSET>"
+		    ubiformat /dev/mtd$mtdnum -s $CU_UBI_VID_HEADER_OFFSET -y
+		    echo "Forcing ubiattach with possible non standard VID header offset of <$CU_UBI_VID_HEADER_OFFSET>"
+		    ubiattach -m "$mtdnum" -O $CU_UBI_VID_HEADER_OFFSET
+		else
+		    ubiformat /dev/mtd$mtdnum -y
+		    ubiattach -m "$mtdnum"
+		fi
 		sync
 		ubidev="$( nand_find_ubi "$CI_UBIPART" )"
 		[ "$has_env" -gt 0 ] && {
diff --git a/target/linux/lantiq/base-files/lib/upgrade/platform.sh b/target/linux/lantiq/base-files/lib/upgrade/platform.sh
index 840ebe7..08f8275 100755
--- a/target/linux/lantiq/base-files/lib/upgrade/platform.sh
+++ b/target/linux/lantiq/base-files/lib/upgrade/platform.sh
@@ -17,7 +17,8 @@ platform_do_upgrade() {
 	bt,homehub-v3a|\
 	bt,homehub-v5a|\
 	zyxel,p-2812hnu-f1|\
-	zyxel,p-2812hnu-f3)
+	zyxel,p-2812hnu-f3|\
+	lantiq,vgv952cjw33-e-ir)
 		nand_do_upgrade $1
 		;;
 	*)
@@ -25,3 +26,16 @@ platform_do_upgrade() {
 		;;
 	esac
 }
+
+platform_nand_pre_upgrade() {
+	local board=$(board_name)
+	echo "platform_nand_pre_upgrade()"
+
+	case "$board" in
+	lantiq,vgv952cjw33-e-ir )
+		# This is a global defined in nand.sh, sets another VID header offset than default.
+		echo "Set header offset"
+		CU_UBI_VID_HEADER_OFFSET="2048"
+		;;
+	esac
+}
-- 
2.7.4


From 4267357a4c9cdcde244d51e64e9e423337086494 Mon Sep 17 00:00:00 2001
From: arny <arnysch@gmx.net>
Date: Fri, 9 Nov 2018 23:29:23 +0100
Subject: [PATCH 05/16] Use standard kernel params, no vpe, no UBI

---
 .../files-4.14/arch/mips/boot/dts/VGV952CJW33-E-IR.dts | 18 +++++++++++-------
 1 file changed, 11 insertions(+), 7 deletions(-)

diff --git a/target/linux/lantiq/files-4.14/arch/mips/boot/dts/VGV952CJW33-E-IR.dts b/target/linux/lantiq/files-4.14/arch/mips/boot/dts/VGV952CJW33-E-IR.dts
index e0bd4c9..0a20318 100644
--- a/target/linux/lantiq/files-4.14/arch/mips/boot/dts/VGV952CJW33-E-IR.dts
+++ b/target/linux/lantiq/files-4.14/arch/mips/boot/dts/VGV952CJW33-E-IR.dts
@@ -13,10 +13,14 @@
 		// Bootargs when no vpe is used
 		// bootargs = "console=ttyLTQ0,115200 ubi.mtd=12,2048 panic=1 DTS-TEST-SEQNO=77 root=/dev/ubiblock0_0 rootdelay=7";
 
+		// No vpe, no partition declared as UBI partition
+		bootargs = "console=ttyLTQ0,115200";
+
 		// Bootargs when vpe is used
-			// Bootargs to boot from mtd12 ubifs
+		// Bootargs to boot from mtd12 ubifs
 			// bootargs = "console=ttyLTQ0,115200 ubi.mtd=12,2048 panic=1 DTS-TEST-SEQNO=77  root=/dev/ubiblock0_0 rootdelay=7 mem=116M phym=128M vpe1_load_addr=0x87e00000 vpe1_mem=2M maxvpes=1 maxtcs=1 nosmp";
-			bootargs = "console=ttyLTQ0,115200 ubi.mtd=12,2048 panic=1 DTS-TEST-SEQNO=77 root=/dev/ubiblock0_0 rootdelay=7 mem=116M phym=128M vpe1_load_addr=0x87e00000 vpe1_mem=2M maxvpes=1 maxtcs=1 nosmp";
+			//bootargs = "console=ttyLTQ0,115200 ubi.mtd=12,2048 panic=1 DTS-TEST-SEQNO=77 root=/dev/ubiblock0_0 rootdelay=7 mem=116M phym=128M vpe1_load_addr=0x87e00000 vpe1_mem=2M maxvpes=1 maxtcs=1 nosmp";
+			//bootargs = "console=ttyLTQ0,115200 mem=116M phym=128M vpe1_load_addr=0x87e00000 vpe1_mem=2M maxvpes=1 maxtcs=1 nosmp";
 
 			// Bootargs to boot from sda1
 			// bootargs = "console=ttyLTQ0,115200 panic=1 DTS-TEST-SEQNO=77 root=/dev/sda1 rootdelay=7 rootfstype=f2fs mem=116M phym=128M vpe1_load_addr=0x87e00000 vpe1_mem=2M maxvpes=1 maxtcs=1 nosmp";
@@ -192,8 +196,8 @@
                 };
 
                 partition@40000 {
-                    label = "rootfs";		// Called "rootfs" in u-boot env. Contains orig. squashfs rootfs
-                    reg = <0x40000 0x3C00000>;
+                    label = "rootfs";		// Called "rootfs" in u-boot env
+                    reg = <0x40000 0x3C00000>;	// Auto mounted as rootfs if no UBI volume named "rootfs" exists
                 };
 
                 partition@3C40000 {
@@ -246,9 +250,9 @@
                     reg = <0x4C00000 0x4000000>;
                 };
 
-                partition@8C00000 {			// Used for our real open OpenWrt system for ubi-squashfs (rootfs) and ubifs (rootfs_data)
-                    label = "ubi";			// Rename to "firmware" for special squashfs-rootfs/jffs2-rootfs_data treatment by OpenWrt
-                    reg = <0x8C00000 0x13200000>;
+                partition@8C00000 {			// Rename to "ubi" for auto ubi attachment and usage of rootfs, rootfs_data, kernel volumes
+                    label = "misc";			// Rename to "firmware" for special squashfs-rootfs/jffs2-rootfs_data treatment
+                    reg = <0x8C00000 0x13200000>;	
                 };
 
                 partition@1BE00000 {
-- 
2.7.4


From 9898eabf4399f622aae5f08b2c444eab4417cd19 Mon Sep 17 00:00:00 2001
From: arny <arnysch@gmx.net>
Date: Wed, 7 Nov 2018 13:16:03 +0100
Subject: [PATCH 06/16] Avoid using device specific eb904.mk for building the
 images

With only small changes, the standard Makefile for building the target
images can be used.

Also abandon building an "ubinized" image ("squashfs-rootfs-ubinized.bin"),
because sysupgrade knows to create ubi volumes from the kernel and rootfs
parts within a squashfs-sysupgrade.bin file.

Signed-off-by: arny <arnysch@gmx.net>
---
 target/linux/lantiq/image/Makefile | 32 +++++++++++++++++++++++++++++++-
 1 file changed, 31 insertions(+), 1 deletion(-)

diff --git a/target/linux/lantiq/image/Makefile b/target/linux/lantiq/image/Makefile
index 2891256..f33dad3 100644
--- a/target/linux/lantiq/image/Makefile
+++ b/target/linux/lantiq/image/Makefile
@@ -12,7 +12,6 @@ KERNEL_LOADADDR = 0x80002000
 KERNEL_ENTRY = 0x80002000
 
 include $(TOPDIR)/rules.mk
-include eb904.mk
 include $(INCLUDE_DIR)/image.mk
 
 ifeq ($(SUBTARGET),xway)
@@ -21,6 +20,21 @@ else
   UBIFS_OPTS := -m 2048 -e 126KiB -c 4096
 endif
 
+define Build/append-uImage-rootfs
+	mkimage -A mips -O linux -C none -T filesystem  \
+		-n 'OpenWRT RootFS' \
+		-d $(IMAGE_ROOTFS) $@.mkimage
+	cat $@.mkimage >> $@
+endef
+
+define Build/append-uImage-dummyrootfs
+	echo -n "dummy" > $@.dummyrootfs
+	mkimage -A mips -O linux -C none -T filesystem  \
+		-n 'OpenWRT dummy RootFS' \
+	-d $@.dummyrootfs $@.mkimage
+	cat $@.mkimage >> $@
+endef
+
 define Build/append-avm-fakeroot
 	cat ./eva.dummy.squashfs >> $@
 endef
@@ -596,6 +610,22 @@ define Device/bt_homehub-v5a
 endef
 TARGET_DEVICES += bt_homehub-v5a
 
+define Device/lantiq_vgv952cjw33-e-ir
+  $(Device/NAND)
+  BOARD_NAME := VGV952CJW33-E-IR
+  DEVICE_DTS := VGV952CJW33-E-IR
+  DEVICE_TITLE := Easybox 904 / Arcadyan VGV952CJW33-E-IR
+  DEVICE_PACKAGES := kmod-usb-dwc2 kmod-ltq-tapi kmod-ltq-vmmc wpad-basic
+  SUPPORTED_DEVICES += VGV952CJW33-E-IR
+  IMAGES := sysupgrade.bin fullimage.img
+  IMAGE/fullimage.img := append-uImage-rootfs | pad-offset 16 0 | append-kernel
+  # There is no typical use case for this, so commented out. Only here for documentary reason:
+  # Adjust initramfs build so it is flashable to a kernel partition even by the original U-Boot of the eb904
+  # with the reset-button-during-power-on recovery procedure. After boot it won't use flash any longer.
+  # KERNEL_INITRAMFS := kernel-bin | append-dtb | lzma | uImage lzma | pad-offset 16 0 | append-uImage-dummyrootfs | check-size 0x500000
+endef
+TARGET_DEVICES += lantiq_vgv952cjw33-e-ir
+
 define Device/netgear_dm200
   DEVICE_DTS := DM200
   IMAGES := sysupgrade.bin factory.img
-- 
2.7.4


From a3ec53faf809ec645e7d8bf37edc725813d82c89 Mon Sep 17 00:00:00 2001
From: arny <arnysch@gmx.net>
Date: Wed, 7 Nov 2018 13:17:26 +0100
Subject: [PATCH 07/16] Remove obsolete eb904.mk

Not longer used, as relevant stuff is now in
target/linux/lantiq/image/Makefile

Signed-off-by: arny <arnysch@gmx.net>
---
 target/linux/lantiq/image/eb904.mk | 105 -------------------------------------
 1 file changed, 105 deletions(-)
 delete mode 100644 target/linux/lantiq/image/eb904.mk

diff --git a/target/linux/lantiq/image/eb904.mk b/target/linux/lantiq/image/eb904.mk
deleted file mode 100644
index 082e3cb..0000000
--- a/target/linux/lantiq/image/eb904.mk
+++ /dev/null
@@ -1,105 +0,0 @@
-#
-# Copyright (C) 2010-2016 OpenWrt.org
-#
-# This is free software, licensed under the GNU General Public License v2.
-# See /LICENSE for more information.
-#
-NAND_BLOCKSIZE ?= 2048-128k
-
-define Image/Build
-    $(call Image/Build/$(1),$(1))
-endef
-
-define Build/uImage_eb904
-	mkimage -A $(LINUX_KARCH) \
-		-O linux -T kernel \
-		-C $(1) -a $(KERNEL_LOADADDR) -e $(if $(KERNEL_ENTRY),$(KERNEL_ENTRY),$(KERNEL_LOADADDR)) \
-		-n '$(if $(UIMAGE_NAME),$(UIMAGE_NAME),$(call toupper,$(LINUX_KARCH)) LEDE Linux-$(LINUX_VERSION))' \
-		-d $@ $@.new.padded
-	@mv $@.new.padded $@
-endef
-
-define Build/fullimage_eb904_root
-	mkimage -A mips -O linux -C lzma -T filesystem -a 0x00 \
-		-e 0x00 -n 'LEDE RootFS' \
-		-d $@ $@.mkimage
-	cat $@.mkimage > $@
-endef
-
-define Build/fullimage_eb904_function
-	IMAGE_LIST="$(1) \
-	$(2)"; \
-	ONEIMAGE="$(1).oneimage"; \
-	PLATFORM=`echo $(SUBTARGET)|cut -d_ -f2-|awk '{ print toupper($$1) }'`; \
-	rm -f $$ONEIMAGE; \
-	echo "IMAGE_LIST: $$IMAGE_LIST"; \
-	for i in $$IMAGE_LIST; do \
-		if [ -e $$i  ] ; then \
-			echo "Prepare $$i"; \
-			len=`wc -c $$i | awk '{ printf $$1 }'`; \
-			pad=`expr 16 - $$len % 16`; \
-			pad=`expr $$pad % 16`; \
-			if [ -e $$ONEIMAGE.tmp ] ; then \
-				cat $$i >> $$ONEIMAGE.tmp; \
-			else \
-				cat $$i > $$ONEIMAGE.tmp; \
-			fi; \
-			while [ $$pad -ne 0 ]; do \
-				echo -n "0" >> $$ONEIMAGE.tmp; \
-				pad=`expr $$pad - 1`; \
-			done; \
-		else \
-			echo "$$i not found!"; \
-			rm -f $$ONEIMAGE.tmp; \
-			exit 1; \
-		fi; \
-	done; \
-	mkimage -A MIPS -O Linux -C none -T multi -e 0x00 -a 0x00 -n \
-		"$$PLATFORM Fullimage" -d $$ONEIMAGE.tmp $$ONEIMAGE; \
-	rm -f $$ONEIMAGE.tmp; \
-	chmod 644 $$ONEIMAGE;
-
-	cat $(1).oneimage > $(1);
-endef
-
-define Build/fullimage_eb904_recovery
-	$(call Build/fullimage_eb904_function,$@,$(KDIR)/tmp/$(KERNEL_INITRAMFS_IMAGE))
-endef
-define Build/fullimage_eb904
-	$(call Build/fullimage_eb904_function,$@,$(IMAGE_KERNEL))
-endef
-
-ifeq ($(SUBTARGET),xrx200)
-
-# VR9
-define Device/lantiq_vgv952cjw33-e-ir
-  BLOCKSIZE := 126976
-  PAGESIZE := 2048
-  SUBPAGESIZE := 2048
-  FILESYSTEMS += ubifs
-  UBIFS_OPTS := -m 2048 -e 126976 -c 2047
-
-  IMAGE_SIZE := 32768k
-  MAGIC := 0x27051956
-  DEVICE_TITLE := VGV952CJW33-E-IR - Lantiq Easybox 904
-  DEVICE_DTS := VGV952CJW33-E-IR
-  DEVICE_PACKAGES := kmod-usb-dwc2 kmod-ltq-tapi kmod-ltq-vmmc
-  KERNEL := kernel-bin | append-dtb | lzma | pad-offset 128k 64 | uImage lzma
-#  IMAGES := fullimage-recovery.bin
-  IMAGES := sysupgrade.bin rootfs-ubinized.bin
-  IMAGE/fullimage-ubinized.bin := append-ubi | fullimage_eb904_root | fullimage_eb904 | check-size $$$$(IMAGE_SIZE)
-  IMAGE/fullimage-recovery.bin := append-uImage-fakeroot-hdr | fullimage_eb904_recovery | check-size $$$$(IMAGE_SIZE)
-  IMAGE/sysupgrade.bin := sysupgrade-tar | append-metadata
-  IMAGE/rootfs-ubinized.bin := append-rootfs
-  SUPPORTED_DEVICES += VGV952CJW33-E-IR
-
-#  experimental settings
-#  FEATURES += jffs2_nand
-#  FILESYSTEMS += jffs2-nand-2048-128k
-#  IMAGES := fullimage-ubinized.bin fullimage-jffs2.bin
-#  IMAGE/fullimage-jffs2.bin    := append-rootfs | pad-offset 4096 0 | fullimage_eb904 | check-size $$$$(IMAGE_SIZE)
-endef
-TARGET_DEVICES += lantiq_vgv952cjw33-e-ir
-
-endif
-
-- 
2.7.4


From ee2207ee417263ac20bc4531b164d56f9ab1cc04 Mon Sep 17 00:00:00 2001
From: arny <arnysch@gmx.net>
Date: Tue, 13 Nov 2018 11:13:12 +0100
Subject: [PATCH 08/16] Use partition 'ubi' (mtd12) for rootfs and rootfs_data;
 use 512 UBI sub-blocks

Note that if an old UBI partition exists with VID header offset 2048, then
the kernel will log errors when trying to attach this partition.

This is no problem if the system rootfs is in RAM (initramfs)
or if it is located on a non UBI partition.

When sysupgrade realizes that 'ubi' cannot be attached (due to old format),
it will ubiformat the partition for subpage usage und then install the rootfs.

Signed-off-by: arny <arnysch@gmx.net>
---
 .../lantiq/base-files/lib/upgrade/platform.sh      |  5 +--
 .../arch/mips/boot/dts/VGV952CJW33-E-IR.dts        | 40 ++++++++++++++--------
 target/linux/lantiq/image/Makefile                 | 23 +++++++++----
 3 files changed, 44 insertions(+), 24 deletions(-)

diff --git a/target/linux/lantiq/base-files/lib/upgrade/platform.sh b/target/linux/lantiq/base-files/lib/upgrade/platform.sh
index 08f8275..c5d2706 100755
--- a/target/linux/lantiq/base-files/lib/upgrade/platform.sh
+++ b/target/linux/lantiq/base-files/lib/upgrade/platform.sh
@@ -34,8 +34,9 @@ platform_nand_pre_upgrade() {
 	case "$board" in
 	lantiq,vgv952cjw33-e-ir )
 		# This is a global defined in nand.sh, sets another VID header offset than default.
-		echo "Set header offset"
-		CU_UBI_VID_HEADER_OFFSET="2048"
+		# (now disabled, as it looks like eb904 can handle 512 byte subpages as reported by driver)
+		#echo "Set header offset"
+		#CU_UBI_VID_HEADER_OFFSET="2048"
 		;;
 	esac
 }
diff --git a/target/linux/lantiq/files-4.14/arch/mips/boot/dts/VGV952CJW33-E-IR.dts b/target/linux/lantiq/files-4.14/arch/mips/boot/dts/VGV952CJW33-E-IR.dts
index 0a20318..5f1a3bf 100644
--- a/target/linux/lantiq/files-4.14/arch/mips/boot/dts/VGV952CJW33-E-IR.dts
+++ b/target/linux/lantiq/files-4.14/arch/mips/boot/dts/VGV952CJW33-E-IR.dts
@@ -10,20 +10,30 @@
 	compatible = "lantiq,vgv952cjw33-e-ir", "lantiq,xway", "lantiq,vr9";
 
 	chosen {
-		// Bootargs when no vpe is used
-		// bootargs = "console=ttyLTQ0,115200 ubi.mtd=12,2048 panic=1 DTS-TEST-SEQNO=77 root=/dev/ubiblock0_0 rootdelay=7";
+	    // No vpe, both cores used for linux:
 
-		// No vpe, no partition declared as UBI partition
+		//Rootfs is in partition 'ubi' if present, volume 'rootfs' (1st search prio). Or in mtd partition called 'rootfs' (2nd prio).
 		bootargs = "console=ttyLTQ0,115200";
 
-		// Bootargs when vpe is used
-		// Bootargs to boot from mtd12 ubifs
-			// bootargs = "console=ttyLTQ0,115200 ubi.mtd=12,2048 panic=1 DTS-TEST-SEQNO=77  root=/dev/ubiblock0_0 rootdelay=7 mem=116M phym=128M vpe1_load_addr=0x87e00000 vpe1_mem=2M maxvpes=1 maxtcs=1 nosmp";
-			//bootargs = "console=ttyLTQ0,115200 ubi.mtd=12,2048 panic=1 DTS-TEST-SEQNO=77 root=/dev/ubiblock0_0 rootdelay=7 mem=116M phym=128M vpe1_load_addr=0x87e00000 vpe1_mem=2M maxvpes=1 maxtcs=1 nosmp";
-			//bootargs = "console=ttyLTQ0,115200 mem=116M phym=128M vpe1_load_addr=0x87e00000 vpe1_mem=2M maxvpes=1 maxtcs=1 nosmp";
+		// Obsolete:
+		// bootargs = "console=ttyLTQ0,115200 ubi.mtd=12,2048 panic=1 DTS-TEST-SEQNO=77 root=/dev/ubiblock0_0 rootdelay=7";
+
 
-			// Bootargs to boot from sda1
-			// bootargs = "console=ttyLTQ0,115200 panic=1 DTS-TEST-SEQNO=77 root=/dev/sda1 rootdelay=7 rootfstype=f2fs mem=116M phym=128M vpe1_load_addr=0x87e00000 vpe1_mem=2M maxvpes=1 maxtcs=1 nosmp";
+	    // With vpe, one core dedicated to phone audio signal processing
+
+		// bootargs = "console=ttyLTQ0,115200 mem=116M phym=128M vpe1_load_addr=0x87e00000 vpe1_mem=2M maxvpes=1 maxtcs=1 nosmp";
+
+		// Bootargs to boot from sda1
+		// bootargs = "console=ttyLTQ0,115200 root=/dev/sda1 rootdelay=7 rootfstype=f2fs mem=116M phym=128M vpe1_load_addr=0x87e00000 vpe1_mem=2M maxvpes=1 maxtcs=1 nosmp";
+
+		// Obsolete: 
+		// bootargs = "console=ttyLTQ0,115200 ubi.mtd=12,2048 panic=1 DTS-TEST-SEQNO=77  root=/dev/ubiblock0_0 rootdelay=7 mem=116M phym=128M vpe1_load_addr=0x87e00000 vpe1_mem=2M maxvpes=1 maxtcs=1 nosmp";
+		// Bootargs to boot from mtd12 ubifs
+		// bootargs = "console=ttyLTQ0,115200 ubi.mtd=12,2048 panic=1 DTS-TEST-SEQNO=77  root=/dev/ubiblock0_0 rootdelay=7 mem=116M phym=128M vpe1_load_addr=0x87e00000 vpe1_mem=2M maxvpes=1 maxtcs=1 nosmp";
+		// bootargs = "console=ttyLTQ0,115200 ubi.mtd=12,2048 panic=1 DTS-TEST-SEQNO=77 root=/dev/ubiblock0_0 rootdelay=7 mem=116M phym=128M vpe1_load_addr=0x87e00000 vpe1_mem=2M maxvpes=1 maxtcs=1 nosmp";
+		// bootargs = "console=ttyLTQ0,115200 mem=116M phym=128M vpe1_load_addr=0x87e00000 vpe1_mem=2M maxvpes=1 maxtcs=1 nosmp";
+		// Bootargs to boot from sda1
+		// bootargs = "console=ttyLTQ0,115200 panic=1 DTS-TEST-SEQNO=77 root=/dev/sda1 rootdelay=7 rootfstype=f2fs mem=116M phym=128M vpe1_load_addr=0x87e00000 vpe1_mem=2M maxvpes=1 maxtcs=1 nosmp";
 	};
 
 	memory@0 {
@@ -196,12 +206,12 @@
                 };
 
                 partition@40000 {
-                    label = "rootfs";		// Called "rootfs" in u-boot env
+                    label = "rootfs1";		// Called "rootfs" in original u-boot env.
                     reg = <0x40000 0x3C00000>;	// Auto mounted as rootfs if no UBI volume named "rootfs" exists
                 };
 
                 partition@3C40000 {
-                    label = "kernel";		// Called "kernel" in u-boot env. Contains orig. kernel
+                    label = "kernel";		// Called "kernel" in original u-boot env.
                     reg = <0x3C40000 0x500000>;
                 };
 
@@ -250,9 +260,9 @@
                     reg = <0x4C00000 0x4000000>;
                 };
 
-                partition@8C00000 {			// Rename to "ubi" for auto ubi attachment and usage of rootfs, rootfs_data, kernel volumes
-                    label = "misc";			// Rename to "firmware" for special squashfs-rootfs/jffs2-rootfs_data treatment
-                    reg = <0x8C00000 0x13200000>;	
+                partition@8C00000 {			// Called "misc" in original u-boot env.
+                    label = "ubi";			// Rename to "ubi" for auto ubi attachment and usage of rootfs, rootfs_data, kernel volumes
+                    reg = <0x8C00000 0x13200000>;	// Rename to "firmware" for special squashfs-rootfs/jffs2-rootfs_data treatment
                 };
 
                 partition@1BE00000 {
diff --git a/target/linux/lantiq/image/Makefile b/target/linux/lantiq/image/Makefile
index f33dad3..a3828eb 100644
--- a/target/linux/lantiq/image/Makefile
+++ b/target/linux/lantiq/image/Makefile
@@ -31,7 +31,7 @@ define Build/append-uImage-dummyrootfs
 	echo -n "dummy" > $@.dummyrootfs
 	mkimage -A mips -O linux -C none -T filesystem  \
 		-n 'OpenWRT dummy RootFS' \
-	-d $@.dummyrootfs $@.mkimage
+		-d $@.dummyrootfs $@.mkimage
 	cat $@.mkimage >> $@
 endef
 
@@ -617,12 +617,21 @@ define Device/lantiq_vgv952cjw33-e-ir
   DEVICE_TITLE := Easybox 904 / Arcadyan VGV952CJW33-E-IR
   DEVICE_PACKAGES := kmod-usb-dwc2 kmod-ltq-tapi kmod-ltq-vmmc wpad-basic
   SUPPORTED_DEVICES += VGV952CJW33-E-IR
-  IMAGES := sysupgrade.bin fullimage.img
-  IMAGE/fullimage.img := append-uImage-rootfs | pad-offset 16 0 | append-kernel
-  # There is no typical use case for this, so commented out. Only here for documentary reason:
-  # Adjust initramfs build so it is flashable to a kernel partition even by the original U-Boot of the eb904
-  # with the reset-button-during-power-on recovery procedure. After boot it won't use flash any longer.
-  # KERNEL_INITRAMFS := kernel-bin | append-dtb | lzma | uImage lzma | pad-offset 16 0 | append-uImage-dummyrootfs | check-size 0x500000
+# If the rootfs/squashfs should be placed in mtd1: flashing can be done with the reset-button-during-
+# power-on recovery procedure using fullimage.img, or with sysupgrade procedure using sysupgrade.bin.
+# In the .dts file, partition mtd1 MUST be named 'rootfs', and partition mtd12 MUST NOT be named 'ubi'.
+ #IMAGES := sysupgrade.bin fullimage.img
+ #IMAGE/fullimage.img := append-uImage-rootfs | pad-offset 16 0 | append-kernel
+# If the rootfs/squashfs should be placed in an UBI volume in mtd12:
+# flashing can be done with the sysupgrade procedure.
+# In the .dts file, partition mtd1 MUST NOT be named 'rootfs', and partition mtd12 MUST be named 'ubi'.
+  IMAGES := sysupgrade.bin
+# Generate an initramfs file containing an additional dummy squashfs image. This way the original vendor U-Boot
+# can flash it to the mtd2 kernel partition via the reset-button-press-during-power-on recovery procedure
+# if 1) size is max 0x500000 bytes and 2) the initramfs file is manually renamed to fullimage.img.
+# BTW: the uboot-lantiq-easybox904xdsl U-Boot allows larger sizes and starts the initramfs directly without flashing.
+  KERNEL_INITRAMFS := kernel-bin | append-dtb | lzma | uImage lzma | pad-offset 16 0 | append-uImage-dummyrootfs
+ #KERNEL_INITRAMFS := kernel-bin | append-dtb | lzma | uImage lzma | pad-offset 16 0 | append-uImage-dummyrootfs | check-size 0x500000
 endef
 TARGET_DEVICES += lantiq_vgv952cjw33-e-ir
 
-- 
2.7.4


From d140625d0eba67db5d79abb922c5607f494090dd Mon Sep 17 00:00:00 2001
From: arny <arnysch@gmx.net>
Date: Fri, 23 Nov 2018 11:46:03 +0100
Subject: [PATCH 09/16] Add .dts entries to make second USB port work

Signed-off-by: arny <arnysch@gmx.net>
---
 .../lantiq/files-4.14/arch/mips/boot/dts/VGV952CJW33-E-IR.dts    | 9 +++++++++
 1 file changed, 9 insertions(+)

diff --git a/target/linux/lantiq/files-4.14/arch/mips/boot/dts/VGV952CJW33-E-IR.dts b/target/linux/lantiq/files-4.14/arch/mips/boot/dts/VGV952CJW33-E-IR.dts
index 5f1a3bf..de15692 100644
--- a/target/linux/lantiq/files-4.14/arch/mips/boot/dts/VGV952CJW33-E-IR.dts
+++ b/target/linux/lantiq/files-4.14/arch/mips/boot/dts/VGV952CJW33-E-IR.dts
@@ -344,11 +344,20 @@
     status = "okay";
 };
 
+&usb_phy1 {
+    status = "okay";
+};
+
 &usb0 {
     status = "okay";
     vbus-supply = <&usb_vbus>;
 };
 
+&usb1 {
+    status = "okay";
+    vbus-supply = <&usb_vbus>;
+};
+
 &eth0 {
 	lan: interface@0 {
 		compatible = "lantiq,xrx200-pdi";
-- 
2.7.4


From e5504478996228514f1b6665cac87b0f405581a2 Mon Sep 17 00:00:00 2001
From: Vitalii Kovzik <vitalii.kovzik@gmail.com>
Date: Mon, 12 Nov 2018 22:10:48 +0100
Subject: [PATCH 10/16] Add gpio-spi driver for 74hc595 pin extender.

---
 .../arch/mips/boot/dts/VGV952CJW33-E-IR.dts        | 90 +++++++++++++++++-----
 1 file changed, 72 insertions(+), 18 deletions(-)

diff --git a/target/linux/lantiq/files-4.14/arch/mips/boot/dts/VGV952CJW33-E-IR.dts b/target/linux/lantiq/files-4.14/arch/mips/boot/dts/VGV952CJW33-E-IR.dts
index de15692..c5b38b0 100644
--- a/target/linux/lantiq/files-4.14/arch/mips/boot/dts/VGV952CJW33-E-IR.dts
+++ b/target/linux/lantiq/files-4.14/arch/mips/boot/dts/VGV952CJW33-E-IR.dts
@@ -92,6 +92,72 @@
 		};
 	};
 
+	spi {
+		compatible = "spi-gpio";
+		address-cells = <1>;
+		size-cells = <0>;
+
+		gpio-sck = <&gpio 29 GPIO_ACTIVE_HIGH >;
+		gpio-mosi = <&gpio 30 GPIO_ACTIVE_HIGH >;
+		num-chipselects = <1>;
+		cs-gpios = <&gpio 39 GPIO_ACTIVE_HIGH >; 
+
+		hc595: gpio_spi@0 {
+			compatible = "fairchild,74hc595";
+			reg = <0>;
+			registers-number = <1>;
+			spi-max-frequency = <1000000>;
+			spi-cpol = <0>;
+			spi-cpha = <0>;
+			gpio-controller;
+			#gpio-cells = <2>;
+		};
+	};
+
+	gpio_export {
+		compatible = "gpio-export";
+		#size-cells = <0>;
+
+		out_0 { /*Unknown*/
+			gpio-export,name = "hc595_0";
+			gpio-export,output = <1>;
+			gpios = <&hc595 0 GPIO_ACTIVE_HIGH>;
+		};
+		out_1 {/*Unknown*/
+			gpio-export,name = "hc595_1";
+			gpio-export,output = <1>;
+			gpios = <&hc595 1 GPIO_ACTIVE_HIGH>;
+		};
+
+		// out_2 is used to reset touch IC and owned by eb904_keypad
+
+		out_3 {/*Unknown*/
+			gpio-export,name = "hc595_3";
+			gpio-export,output = <1>;
+			gpios = <&hc595 3 GPIO_ACTIVE_HIGH>;
+		};
+		out_dsl_eth { /* Switches DSL line + 100MiB eth or 1GiB ethernet on DSL/WAN input*/
+			gpio-export,name = "dsl_en";
+			gpio-export,output = <1>;
+			gpios = <&hc595 4 GPIO_ACTIVE_HIGH>;
+		};
+		out_5 { /*Relay*/
+			gpio-export,name = "hc595_5";
+			gpio-export,output = <1>;
+			gpios = <&hc595 5 GPIO_ACTIVE_HIGH>;
+		};
+		out_6 { /*Relay*/
+			gpio-export,name = "hc595_6";
+			gpio-export,output = <1>;
+			gpios = <&hc595 6 GPIO_ACTIVE_HIGH>;
+		};
+		out_7 { /*Relay*/
+			gpio-export,name = "hc595_7";
+			gpio-export,output = <1>;
+			gpios = <&hc595 7 GPIO_ACTIVE_HIGH>;
+		};
+	};
+
 	i2c {
 		compatible = "i2c-gpio";
 		#address-cells = <1>;
@@ -109,10 +175,8 @@
 			interrupt-parent = <&icu0>;
 			interrupts = <135>;
 			eb904,interrupt-gpio = <&gpio  0 GPIO_ACTIVE_HIGH /* EXIN */>;
-			eb904,ctrl-clk-gpios = <&gpio 29 GPIO_ACTIVE_HIGH /* clk */>;
-			eb904,ctrl-dat-gpios = <&gpio 30 GPIO_ACTIVE_HIGH /* dat */>;
-			eb904,ctrl-out-gpios = <&gpio 39 GPIO_ACTIVE_HIGH /* out */>;
-			eb904,alphas = /bits/ 8
+			eb904,ctrl-rst-gpio = <&hc595 2 GPIO_ACTIVE_LOW /* rst */>;
+            eb904,alphas = /bits/ 8
 				 <0x07 /* left */
 				  0x0a /* down */
 				  0x0a /* right */
@@ -287,20 +351,6 @@
 *  Following is the very experimental part which is broken and requires much more elaboration
 */
 
-&stp {
-	compatible = "lantiq,gpio-stp-xway";
-	reg = <0xE100BB0 0x40>;
-	#gpio-cells = <2>;
-	gpio-controller;
-
-	lantiq,shadow = <0xffff>;
-	lantiq,groups = <0x7>;
-	lantiq,dsl = <0x3>;
-	lantiq,phy1 = <0x7>;
-	lantiq,phy2 = <0x7>;
-};
-
-
 // From FRITZ3370.dts
 &gpio {
 	pinctrl-names = "default";
@@ -337,6 +387,10 @@
 			lantiq,open-drain;
 			lantiq,pull = <0>;
 		};
+		conf_spi {
+			lantiq,pins = "io29", "io30", "io39"; /* gpiois for spi */
+			lantiq,pull = <2>; /*Pull Up*/
+		};
 	};
 };
 
-- 
2.7.4


From 4c2ef52647c0c335d68ac0d0962c53013b3bcaa9 Mon Sep 17 00:00:00 2001
From: Vitalii Kovzik <vitalii.kovzik@gmail.com>
Date: Fri, 23 Nov 2018 09:32:29 +0100
Subject: [PATCH 11/16] Add DSL relays handling

Save befor rebase
---
 .../network/config/ltq-vdsl-app/files/dsl_control  | 27 +++++++++++++++++++++-
 .../arch/mips/boot/dts/VGV952CJW33-E-IR.dts        | 18 +++++++--------
 2 files changed, 35 insertions(+), 10 deletions(-)

diff --git a/package/network/config/ltq-vdsl-app/files/dsl_control b/package/network/config/ltq-vdsl-app/files/dsl_control
index e62a5e5..fc50633 100644
--- a/package/network/config/ltq-vdsl-app/files/dsl_control
+++ b/package/network/config/ltq-vdsl-app/files/dsl_control
@@ -219,7 +219,29 @@ start_service() {
 	esac
 
 	local annexgpio="/sys/class/gpio/annex"
-	if [ -d "${annexgpio}a" ] && [ -d "${annexgpio}b" ]; then
+	local dsl_en_gpio="/sys/class/gpio/dsl_en"
+	if [ -d "${dsl_en_gpio}" ]; then
+		echo 1 > "${dsl_en_gpio}/value"
+	fi
+	if  [ -d "${annexgpio}a" ] && [ -d "${annexgpio}b" ] && [-d "${annexgpio}j" ]; then
+		case "${annex}" in
+			a*|l*|m*)
+				echo 1 > "${annexgpio}a/value"
+				echo 0 > "${annexgpio}b/value"
+				echo 0 > "${annexgpio}j/value"
+				;;
+			b*)
+				echo 0 > "${annexgpio}a/value"
+				echo 1 > "${annexgpio}b/value"
+				echo 0 > "${annexgpio}j/value"
+				;;
+			i*|j*)
+				echo 0 > "${annexgpio}a/value"
+				echo 0 > "${annexgpio}b/value"
+				echo 1 > "${annexgpio}j/value"
+				;;
+		esac
+	elif [ -d "${annexgpio}a" ] && [ -d "${annexgpio}b" ]; then
 		case "${annex}" in
 			a*|l*|m*)
 				echo 1 > "${annexgpio}a/value"
@@ -313,4 +335,7 @@ stop_service() {
 	DSL_NOTIFICATION_TYPE="DSL_INTERFACE_STATUS" \
 	DSL_INTERFACE_STATUS="DOWN" \
 		/sbin/dsl_notify.sh
+	if [ -d "${dsl_en_gpio}" ]; then
+		echo 0 > "${dsl_en_gpio}/value"
+	fi
 }
diff --git a/target/linux/lantiq/files-4.14/arch/mips/boot/dts/VGV952CJW33-E-IR.dts b/target/linux/lantiq/files-4.14/arch/mips/boot/dts/VGV952CJW33-E-IR.dts
index c5b38b0..8ab778e 100644
--- a/target/linux/lantiq/files-4.14/arch/mips/boot/dts/VGV952CJW33-E-IR.dts
+++ b/target/linux/lantiq/files-4.14/arch/mips/boot/dts/VGV952CJW33-E-IR.dts
@@ -136,25 +136,25 @@
 			gpio-export,output = <1>;
 			gpios = <&hc595 3 GPIO_ACTIVE_HIGH>;
 		};
-		out_dsl_eth { /* Switches DSL line + 100MiB eth or 1GiB ethernet on DSL/WAN input*/
+		out_dsl_eth { /* Switches DSL line + 100MiB eth or 1GiB ethernet on DSL/WAN input. Relay 1.*/
 			gpio-export,name = "dsl_en";
 			gpio-export,output = <1>;
-			gpios = <&hc595 4 GPIO_ACTIVE_HIGH>;
+			gpios = <&hc595 4 GPIO_ACTIVE_LOW>;
 		};
-		out_5 { /*Relay*/
-			gpio-export,name = "hc595_5";
+		out_5 { /* Switches filter for DSL line On/Off. Relays 2 and 3 simultaneously.*/
+			gpio-export,name = "annexj";
 			gpio-export,output = <1>;
 			gpios = <&hc595 5 GPIO_ACTIVE_HIGH>;
 		};
-		out_6 { /*Relay*/
-			gpio-export,name = "hc595_6";
+		out_6 { /* Switch DSL line betwean ISDN modem and Si3050. Relay 5.*/
+			gpio-export,name = "annexb";
 			gpio-export,output = <1>;
 			gpios = <&hc595 6 GPIO_ACTIVE_HIGH>;
 		};
-		out_7 { /*Relay*/
-			gpio-export,name = "hc595_7";
+		out_7 { /* Switch phone outputs N and F betwean analog DSL line and XS1 output from Lantiq SLIC. Relay 4.*/
+			gpio-export,name = "annexa";
 			gpio-export,output = <1>;
-			gpios = <&hc595 7 GPIO_ACTIVE_HIGH>;
+			gpios = <&hc595 7 GPIO_ACTIVE_LOW>;
 		};
 	};
 
-- 
2.7.4


From acbbef349677a11f0a796d4ddb2d7380aaa84803 Mon Sep 17 00:00:00 2001
From: Vitalii Kovzik <vitalii.kovzik@gmail.com>
Date: Tue, 27 Nov 2018 14:44:16 +0100
Subject: [PATCH 12/16] Add pin definition into stop function

---
 package/network/config/ltq-vdsl-app/files/dsl_control | 1 +
 1 file changed, 1 insertion(+)

diff --git a/package/network/config/ltq-vdsl-app/files/dsl_control b/package/network/config/ltq-vdsl-app/files/dsl_control
index fc50633..70a9192 100644
--- a/package/network/config/ltq-vdsl-app/files/dsl_control
+++ b/package/network/config/ltq-vdsl-app/files/dsl_control
@@ -335,6 +335,7 @@ stop_service() {
 	DSL_NOTIFICATION_TYPE="DSL_INTERFACE_STATUS" \
 	DSL_INTERFACE_STATUS="DOWN" \
 		/sbin/dsl_notify.sh
+	local dsl_en_gpio="/sys/class/gpio/dsl_en"
 	if [ -d "${dsl_en_gpio}" ]; then
 		echo 0 > "${dsl_en_gpio}/value"
 	fi
-- 
2.7.4


From cbcfa9edd858c16e5de3ebcd67a6493d76685650 Mon Sep 17 00:00:00 2001
From: arny <arnysch@gmx.net>
Date: Thu, 29 Nov 2018 14:39:37 +0100
Subject: [PATCH 13/16] Fix LED activity level specification in .dts file

As Henning Schild already found out, the power LED is turned on (i.e.
"active") on high GPIO output level. Same is true for the TFT backlight.
(I think this is unusual; it is different from most other devices)

Up to now it was incorrectly specified in the .dts file, which resulted in
some complications. All software which wanted to turn on a LED needed to
write the nonstandard value 0 into the brightness (for the power LED) or the
bl_power (for the backlight) node in the sysfs.

Of course software controlling the LEDs need to be modified to write the
correct value (e.g. lcdcontroller package) into the sysfs node.

This fix also allows to remove the hack in file rc.local of package
"base-files", where so far the backlight LED is turned off.

Code has been successfully tried out (together with changes in package lcdcontroller).

Note that now on initializing the backlight, it will be turned on for half a second. I have not
searched for the reason why this happens, but I find this not to be a problem.

Signed-off-by: arny arnysch@gmx.net
---
 .../arch/mips/boot/dts/VGV952CJW33-E-IR.dts        | 83 +++++++++++-----------
 1 file changed, 42 insertions(+), 41 deletions(-)

diff --git a/target/linux/lantiq/files-4.14/arch/mips/boot/dts/VGV952CJW33-E-IR.dts b/target/linux/lantiq/files-4.14/arch/mips/boot/dts/VGV952CJW33-E-IR.dts
index 8ab778e..a3395c1 100644
--- a/target/linux/lantiq/files-4.14/arch/mips/boot/dts/VGV952CJW33-E-IR.dts
+++ b/target/linux/lantiq/files-4.14/arch/mips/boot/dts/VGV952CJW33-E-IR.dts
@@ -26,7 +26,7 @@
 		// Bootargs to boot from sda1
 		// bootargs = "console=ttyLTQ0,115200 root=/dev/sda1 rootdelay=7 rootfstype=f2fs mem=116M phym=128M vpe1_load_addr=0x87e00000 vpe1_mem=2M maxvpes=1 maxtcs=1 nosmp";
 
-		// Obsolete: 
+		// Obsolete:
 		// bootargs = "console=ttyLTQ0,115200 ubi.mtd=12,2048 panic=1 DTS-TEST-SEQNO=77  root=/dev/ubiblock0_0 rootdelay=7 mem=116M phym=128M vpe1_load_addr=0x87e00000 vpe1_mem=2M maxvpes=1 maxtcs=1 nosmp";
 		// Bootargs to boot from mtd12 ubifs
 		// bootargs = "console=ttyLTQ0,115200 ubi.mtd=12,2048 panic=1 DTS-TEST-SEQNO=77  root=/dev/ubiblock0_0 rootdelay=7 mem=116M phym=128M vpe1_load_addr=0x87e00000 vpe1_mem=2M maxvpes=1 maxtcs=1 nosmp";
@@ -50,7 +50,7 @@
 		bgr;
 		buswidth = <8>;
 		reset-gpios = <&gpio 6 GPIO_ACTIVE_HIGH>;
-		led-gpios = <&gpio 28 GPIO_ACTIVE_LOW>;
+		led-gpios = <&gpio 28 GPIO_ACTIVE_HIGH>;
 		debug = <1>;
 	};
 
@@ -84,11 +84,12 @@
 	};
 
 	gpio-leds {
-			compatible = "gpio-leds";
-			power_green: power {
-			label = "VGV952CJW33:red:power";
-			gpios = <&gpio 31 GPIO_ACTIVE_LOW>;
-			default-state = "keep";
+		compatible = "gpio-leds";
+
+		power_green: power {
+		label = "VGV952CJW33:red:power";
+		gpios = <&gpio 31 GPIO_ACTIVE_HIGH>;
+		default-state = "keep";
 		};
 	};
 
@@ -100,7 +101,7 @@
 		gpio-sck = <&gpio 29 GPIO_ACTIVE_HIGH >;
 		gpio-mosi = <&gpio 30 GPIO_ACTIVE_HIGH >;
 		num-chipselects = <1>;
-		cs-gpios = <&gpio 39 GPIO_ACTIVE_HIGH >; 
+		cs-gpios = <&gpio 39 GPIO_ACTIVE_HIGH >;
 
 		hc595: gpio_spi@0 {
 			compatible = "fairchild,74hc595";
@@ -196,39 +197,39 @@
 	};
 
 	mdio: mdio {
-			compatible = "lantiq,xrx200-mdio";
-			#address-cells = <1>;
-			#size-cells = <0>;
-			phy0: ethernet-phy@0 {
-				reg = <0x0>;
-				compatible = "lantiq,phy11g", "ethernet-phy-ieee802.3-c22";
-			};
-			phy1: ethernet-phy@1 {
-				reg = <0x1>;
-				compatible = "lantiq,phy11g", "ethernet-phy-ieee802.3-c22";
-			};
-			/*
-			phy5: ethernet-phy@5 {
-				reg = <0x5>;
-			};
-			*/
-			phy11: ethernet-phy@11 {
-				reg = <0x11>;
-				compatible = "lantiq,phy11g", "ethernet-phy-ieee802.3-c22";
-			};
-			phy12: ethernet-phy@12 {
-				reg = <0x12>;
-				compatible = "lantiq,phy11g", "ethernet-phy-ieee802.3-c22";
-			};
-			phy13: ethernet-phy@13 {
-				reg = <0x13>;
-				compatible = "lantiq,phy11g", "ethernet-phy-ieee802.3-c22";
-			};				
-			phy14: ethernet-phy@14 {
-				reg = <0x14>;
-				compatible = "lantiq,phy11g", "ethernet-phy-ieee802.3-c22";
-			};
+		compatible = "lantiq,xrx200-mdio";
+		#address-cells = <1>;
+		#size-cells = <0>;
+		phy0: ethernet-phy@0 {
+			reg = <0x0>;
+			compatible = "lantiq,phy11g", "ethernet-phy-ieee802.3-c22";
 		};
+		phy1: ethernet-phy@1 {
+			reg = <0x1>;
+			compatible = "lantiq,phy11g", "ethernet-phy-ieee802.3-c22";
+		};
+		/*
+		phy5: ethernet-phy@5 {
+			reg = <0x5>;
+		};
+		*/
+		phy11: ethernet-phy@11 {
+			reg = <0x11>;
+			compatible = "lantiq,phy11g", "ethernet-phy-ieee802.3-c22";
+		};
+		phy12: ethernet-phy@12 {
+			reg = <0x12>;
+			compatible = "lantiq,phy11g", "ethernet-phy-ieee802.3-c22";
+		};
+		phy13: ethernet-phy@13 {
+			reg = <0x13>;
+			compatible = "lantiq,phy11g", "ethernet-phy-ieee802.3-c22";
+		};
+		phy14: ethernet-phy@14 {
+			reg = <0x14>;
+			compatible = "lantiq,phy11g", "ethernet-phy-ieee802.3-c22";
+		};
+	};
 
 	rtl8367b {
 		compatible = "realtek,rtl8367b";
@@ -417,7 +418,7 @@
 		compatible = "lantiq,xrx200-pdi";
 		#address-cells = <1>;
 		#size-cells = <0>;
-		reg = <0>;                                
+		reg = <0>;
 		mac-address = [ 00 11 22 33 44 55 ];
 		lantiq,switch;
 		ethernet@2 {
-- 
2.7.4


From 3e775bb203c9b4a1f314f6709ea2e232ecc4b1c9 Mon Sep 17 00:00:00 2001
From: arny <arnysch@gmx.net>
Date: Sat, 15 Dec 2018 02:02:57 +0100
Subject: [PATCH 14/16] Add missing space in file /etc/init.d/dsl_control

Signed-off-by: arny <arnysch@gmx.net>
---
 package/network/config/ltq-vdsl-app/files/dsl_control | 2 +-
 1 file changed, 1 insertion(+), 1 deletion(-)

diff --git a/package/network/config/ltq-vdsl-app/files/dsl_control b/package/network/config/ltq-vdsl-app/files/dsl_control
index 70a9192..1ee4309 100644
--- a/package/network/config/ltq-vdsl-app/files/dsl_control
+++ b/package/network/config/ltq-vdsl-app/files/dsl_control
@@ -223,7 +223,7 @@ start_service() {
 	if [ -d "${dsl_en_gpio}" ]; then
 		echo 1 > "${dsl_en_gpio}/value"
 	fi
-	if  [ -d "${annexgpio}a" ] && [ -d "${annexgpio}b" ] && [-d "${annexgpio}j" ]; then
+	if  [ -d "${annexgpio}a" ] && [ -d "${annexgpio}b" ] && [ -d "${annexgpio}j" ]; then
 		case "${annex}" in
 			a*|l*|m*)
 				echo 1 > "${annexgpio}a/value"
-- 
2.7.4


From 2fbe2f5c66a667d524cfc9ff5ffa2c8d75770c39 Mon Sep 17 00:00:00 2001
From: arny <arnysch@gmx.net>
Date: Sun, 9 Dec 2018 15:34:18 +0100
Subject: [PATCH 15/16] VGV952CJW33-E-IR: DTS: Whitespace format change
 (cosmetic only)

---
 .../arch/mips/boot/dts/VGV952CJW33-E-IR.dts        | 220 +++++++++++----------
 1 file changed, 114 insertions(+), 106 deletions(-)

diff --git a/target/linux/lantiq/files-4.14/arch/mips/boot/dts/VGV952CJW33-E-IR.dts b/target/linux/lantiq/files-4.14/arch/mips/boot/dts/VGV952CJW33-E-IR.dts
index a3395c1..929dca4 100644
--- a/target/linux/lantiq/files-4.14/arch/mips/boot/dts/VGV952CJW33-E-IR.dts
+++ b/target/linux/lantiq/files-4.14/arch/mips/boot/dts/VGV952CJW33-E-IR.dts
@@ -177,7 +177,7 @@
 			interrupts = <135>;
 			eb904,interrupt-gpio = <&gpio  0 GPIO_ACTIVE_HIGH /* EXIN */>;
 			eb904,ctrl-rst-gpio = <&hc595 2 GPIO_ACTIVE_LOW /* rst */>;
-            eb904,alphas = /bits/ 8
+			eb904,alphas = /bits/ 8
 				 <0x07 /* left */
 				  0x0a /* down */
 				  0x0a /* right */
@@ -248,104 +248,112 @@
 };
 
 &localbus {
-    ranges = <0 0 0x4000000 0x3ffffff>; // Default in vr9.dtsi is crashing the machine.
-    nand@0 {
-            compatible = "lantiq,nand-xway";
-            bank-width = <2>;
-            reg = <0 0x0 0x2000000>;
-            #address-cells = <1>;
-            #size-cells = <1>;
-            lantiq,cs = <1>;			// Seems to be needed (EASY80920NAND.dts)
-
-            nand-on-flash-bbt;
-            nand-ecc-strength = <3>;
-            nand-ecc-step-size = <256>;
-
-            partitions {
-                compatible = "fixed-partitions";
-                #address-cells = <1>;
-                #size-cells = <1>;
-                partition@0 {
-                    label = "uboot";
-                    reg = <0x0 0x40000>;
-                };
-
-                partition@40000 {
-                    label = "rootfs1";		// Called "rootfs" in original u-boot env.
-                    reg = <0x40000 0x3C00000>;	// Auto mounted as rootfs if no UBI volume named "rootfs" exists
-                };
-
-                partition@3C40000 {
-                    label = "kernel";		// Called "kernel" in original u-boot env.
-                    reg = <0x3C40000 0x500000>;
-                };
-
-                partition@4140000 {
-                    label = "tmp1";
-                    reg = <0x4140000 0x100000>;
-                };
-
-                partition@4240000 {
-                    label = "tmp2";
-                    reg = <0x4240000 0x200000>;
-                };
-
-                partition@4440000 {
-                    label = "sysconfig";
-                    reg = <0x4440000 0x100000>;
-                };
-
-                partition@4540000 {
-                    label = "ubootconfig";
-                    reg = <0x4540000 0x100000>;
-                };
-
-                partition@4640000 {
-                    label = "fwdiag";
-                    reg = <0x4640000 0xC0000>;
-                };
-
-                partition@4700000 {
-                    label = "lcdimage";
-                    reg = <0x4700000 0x300000>;
-                };
-
-                partition@4A00000 {
-                    label = "mfgconfig";
-                    reg = <0x4A00000 0x100000>;
-                };
-
-                partition@4B00000 {
-                    label = "sipdata";
-                    reg = <0x4B00000 0x100000>;
-                };
-
-                partition@4C00000 {
-                    label = "voice";
-                    reg = <0x4C00000 0x4000000>;
-                };
-
-                partition@8C00000 {			// Called "misc" in original u-boot env.
-                    label = "ubi";			// Rename to "ubi" for auto ubi attachment and usage of rootfs, rootfs_data, kernel volumes
-                    reg = <0x8C00000 0x13200000>;	// Rename to "firmware" for special squashfs-rootfs/jffs2-rootfs_data treatment
-                };
-
-                partition@1BE00000 {
-                    label = "rootfs2";
-                    reg = <0x1BE00000 0x3c00000>;
-                };
-
-                partition@1FA00000 {
-                    label = "kernel2";
-                    reg = <0x1FA00000 0x500000>;
-                };
-
-                partition@1FF00000 {
-                    label = "mystery";		// Missing in original u-boot environment, seems to be empty (erased)
-                    reg = <0x1FF00000 0x100000>;
-                };
-            };
-    };
+    //	#address-cells = <2>;					// Just for info. From vr9.dtsi
+    //	#size-cells = <1>;
+    //	ranges = <0 0 0x0       0x3ffffff			// addrsel0	0x3ffffff and 0x4000010 in vr9.dtsi seem to be wrong, because these are size
+    //    	  1 0 0x4000000 0x4000010>;			// addrsel1	parameters. Not really a problem; the drivers we have use their own hardcoded values
+
+	ranges = <0 0 0x0       0x2000000			// addrsel0	Was set up this way by arcadian eb904 U-Boot for nand. Not used by eb904 linux
+		  1 0 0x2000000 0x1000000			// addrsel1	Size 0x1000000 hardcoded in xway_nand.c. Excessive, as first 0x80 is used only
+		  2 0 0x3000000 0x0000800>;			// addrsel2	Size 0x800 hardcoded in display driver. This is the min size supported by ebu
+
+	nand@1 {						// @1 because using ebu BUSCON1/ADDSEL1
+		compatible = "lantiq,nand-xway";
+		reg = <1 0x0 0x80>;				// Only adresses 0x0..0x7F needed (but driver ignores size 0x80 and tells ebu to map 0x1000000)
+
+	    //	bank-width = <2>;				// Not used by any driver code
+		#address-cells = <1>;
+		#size-cells = <1>;
+		lantiq,cs = <1>;				// Seems to be needed (EASY80920NAND.dts)
+
+		nand-on-flash-bbt;
+
+		partitions {
+		compatible = "fixed-partitions";
+			#address-cells = <1>;
+			#size-cells = <1>;
+
+			partition@0 {
+				label = "uboot";
+				reg = <0x0 0x40000>;
+			};
+
+			partition@40000 {
+				label = "rootfs1";		// Called "rootfs" in original u-boot env.
+				reg = <0x40000 0x3C00000>;	// Auto mounted as rootfs if no UBI volume named "rootfs" exists
+			};
+
+			partition@3C40000 {
+				label = "kernel";		// Called "kernel" in original u-boot env.
+				reg = <0x3C40000 0x500000>;
+			};
+
+			partition@4140000 {
+				label = "tmp1";
+				reg = <0x4140000 0x100000>;
+			};
+
+			partition@4240000 {
+				label = "tmp2";
+				reg = <0x4240000 0x200000>;
+			};
+
+			partition@4440000 {
+				label = "sysconfig";
+				reg = <0x4440000 0x100000>;
+			};
+
+			partition@4540000 {
+				label = "ubootconfig";
+				reg = <0x4540000 0x100000>;
+			};
+
+			partition@4640000 {
+				label = "fwdiag";
+				reg = <0x4640000 0xC0000>;
+			};
+
+			partition@4700000 {
+				label = "lcdimage";
+				reg = <0x4700000 0x300000>;
+			};
+
+			partition@4A00000 {
+				label = "mfgconfig";
+				reg = <0x4A00000 0x100000>;
+			};
+
+			partition@4B00000 {
+				label = "sipdata";
+				reg = <0x4B00000 0x100000>;
+			};
+
+			partition@4C00000 {
+				label = "voice";
+				reg = <0x4C00000 0x4000000>;
+			};
+
+			partition@8C00000 {			// Called "misc" in original u-boot env.
+				label = "ubi";			// Rename to "ubi" for auto ubi attachment and usage of rootfs, rootfs_data, kernel volumes
+				reg = <0x8C00000 0x13200000>;	// Rename to "firmware" for special squashfs-rootfs/jffs2-rootfs_data treatment
+			};
+
+			partition@1BE00000 {
+				label = "rootfs2";
+				reg = <0x1BE00000 0x3c00000>;
+			};
+
+			partition@1FA00000 {
+				label = "kernel2";
+				reg = <0x1FA00000 0x500000>;
+			};
+
+			partition@1FF00000 {
+				label = "mystery";		// Missing in original u-boot environment, seems to be empty (erased)
+				reg = <0x1FF00000 0x100000>;
+			};
+		};
+	};
 };
 
 /*
@@ -373,7 +381,7 @@
 
 		pcie-rst {
 			lantiq,pins = "io38";				// FRITZ3370.dts, TDW8970.dts, EASY80920.dtsi, P2812HNUFX.dtsi
-		   //  	lantiq,pins = "io21";				// ARV7519RW22.dts
+		   //	lantiq,pins = "io21";				// ARV7519RW22.dts
 			lantiq,pull = <0>;
 			lantiq,output = <1>;
 		};
@@ -396,21 +404,21 @@
 };
 
 &usb_phy0 {
-    status = "okay";
+	status = "okay";
 };
 
 &usb_phy1 {
-    status = "okay";
+	status = "okay";
 };
 
 &usb0 {
-    status = "okay";
-    vbus-supply = <&usb_vbus>;
+	status = "okay";
+	vbus-supply = <&usb_vbus>;
 };
 
 &usb1 {
-    status = "okay";
-    vbus-supply = <&usb_vbus>;
+	status = "okay";
+	vbus-supply = <&usb_vbus>;
 };
 
 &eth0 {
-- 
2.7.4


From 85d27abe1f7221e710385d789df910781e3a9fec Mon Sep 17 00:00:00 2001
From: arny <arnysch@gmx.net>
Date: Sun, 9 Dec 2018 15:34:18 +0100
Subject: [PATCH 16/16] VGV952CJW33-E-IR: DTS: Fix dts definition for display.

The display (formerly named as easybox904-display) has to be named "display",
see 'Node Names' at https://elinux.org/Device_Tree_Usage.
The @2 is used because using ebu BUSCON2/ADDSEL2.

Signed-off-by: arny <arnysch@gmx.net>
---
 .../arch/mips/boot/dts/VGV952CJW33-E-IR.dts        | 27 +++++++++++-----------
 1 file changed, 13 insertions(+), 14 deletions(-)

diff --git a/target/linux/lantiq/files-4.14/arch/mips/boot/dts/VGV952CJW33-E-IR.dts b/target/linux/lantiq/files-4.14/arch/mips/boot/dts/VGV952CJW33-E-IR.dts
index 929dca4..d619465 100644
--- a/target/linux/lantiq/files-4.14/arch/mips/boot/dts/VGV952CJW33-E-IR.dts
+++ b/target/linux/lantiq/files-4.14/arch/mips/boot/dts/VGV952CJW33-E-IR.dts
@@ -40,20 +40,6 @@
 		reg = <0x0 0x8000000>;
 	};
 
-	easybox904-display{
-		compatible = "ilitek,ili9341_eb904";
-		#address-cells = <1>;
-		#size-cells = <0>;
-		status = "okay";
-		rotate = <270>;
-		fps = <30>;
-		bgr;
-		buswidth = <8>;
-		reset-gpios = <&gpio 6 GPIO_ACTIVE_HIGH>;
-		led-gpios = <&gpio 28 GPIO_ACTIVE_HIGH>;
-		debug = <1>;
-	};
-
 	gpio-keys-polled {
 		compatible = "gpio-keys-polled";
 		#address-cells = <1>;
@@ -354,6 +340,19 @@
 			};
 		};
 	};
+
+	display@2 {						// @2 because using ebu BUSCON2/ADDSEL2. Name not 'easybox904-display',
+		compatible = "ilitek,ili9341_eb904";		// see 'Node Names' at https://elinux.org/Device_Tree_Usage
+		reg = <2 0x0 0x4>;				// Size 0x4 contains 2 byte data and 2 byte command registers
+		status = "okay";
+		rotate = <270>;
+		fps = <30>;
+		bgr;
+		buswidth = <8>;
+		reset-gpios = <&gpio 6 GPIO_ACTIVE_HIGH>;
+		led-gpios = <&gpio 28 GPIO_ACTIVE_HIGH>;
+		debug = <1>;
+	};
 };
 
 /*
-- 
2.7.4

